<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Session</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Claude Code Session</h1>

    <p><a href="/">← Create a new session</a></p>

    <div id="message"></div>
    <div id="session" class="session-content"></div>
  </div>

  <script>
    const sessionEl = document.getElementById('session');
    const messageEl = document.getElementById('message');

    const parseSession = (text) => {
      const lines = text.split('\n');
      const blocks = [];
      // type: 'text' | 'user' | 'assistant'
      function appendLastBlock(content) {
        if (blocks.length === 0) {
          blocks.push({ type: 'text', content: content });
        } else {
          blocks[blocks.length - 1].content += '\n' + content;
        }
      }
      function startNewBlock(type, content) {
        blocks.push({ type: type, content: content });
      }

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if(line.startsWith('>')) {
          // User message
          startNewBlock('user', line);
        } else if (line.startsWith('⏺')) {
          // Assistant message
          startNewBlock('assistant', line);
        } else {
          // Continuation of previous block or new text block
          appendLastBlock(line);
        }
      }

      return { blocks }
    };

    const renderSession = (blocks) => {
      sessionEl.innerHTML = '';

      blocks.forEach(block => {
        let elt = document.createElement('pre');
        const type = block.type;
        elt.textContent = block.content;
        if(type === 'text') {
          elt.className = 'event event-text';
        } if(type === 'user') {
          elt.className = 'event event-user';
        }
        if(type === 'assistant') {
          elt.className = 'event event-assistant';
        }
        sessionEl.appendChild(elt);
      });
    };

    async function loadSession() {
      const pathParts = window.location.pathname.split('/');
      const id = pathParts[pathParts.length - 1];

      if (!id) {
        messageEl.innerHTML = '<div class="error">Invalid session ID</div>';
        return;
      }

      try {
        const response = await fetch(`/api/sessions/${id}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load session');
        }

        const parsed = parseSession(data.content);
        renderSession(parsed.blocks);

        const date = new Date(data.createdAt);
        const dateStr = date.toLocaleString();
        messageEl.innerHTML = `<p>Created: ${dateStr}</p>`;
      } catch (error) {
        messageEl.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        sessionEl.style.display = 'none';
      }
    }

    loadSession();
  </script>
</body>
</html>
